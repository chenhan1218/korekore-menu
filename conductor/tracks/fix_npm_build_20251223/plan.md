# ä¿®å¾© npm run build éŒ¯èª¤ - å¯¦ç¾è¨ˆåŠƒ

**Track ID**: `fix_npm_build_20251223`
**Priority**: High
**Status**: New

---

## ğŸ“ å¯¦ç¾è¨ˆåŠƒ

### Phase 1: å•é¡Œè¨ºæ–·èˆ‡æ–¹æ¡ˆé¸æ“‡

æ­¤éšæ®µç›®æ¨™ï¼šæ·±å…¥åˆ†æ Firebase + Vite å…¼å®¹æ€§å•é¡Œï¼Œè©•ä¼°å¯è¡Œçš„è§£æ±ºæ–¹æ¡ˆã€‚

#### Task 1.1: è©³ç´°è¨ºæ–· Firebase + Vite å…¼å®¹æ€§å•é¡Œ

- [ ] æª¢æŸ¥ç•¶å‰ Firebase ç‰ˆæœ¬èˆ‡ package.json exports é…ç½®
  - [ ] æŸ¥çœ‹ `node_modules/firebase/package.json` çš„ exports æ¬„ä½
  - [ ] ç¢ºèª "." specifier æ˜¯å¦å­˜åœ¨

- [ ] æª¢æŸ¥ Vite ç‰ˆæœ¬èˆ‡é…ç½®
  - [ ] é©—è­‰ Vite v5.0.0 å° CommonJS çš„æ”¯æŒ
  - [ ] æª¢æŸ¥ `vite.config.ts` ä¸­çš„ CommonJS ç›¸é—œè¨­ç½®

- [ ] ç ”ç©¶è§£æ±ºæ–¹æ¡ˆé¸é …
  - [ ] **é¸é … A**: èª¿æ•´ `vite.config.ts` æ·»åŠ  CommonJS å„ªåŒ–
    - ä½¿ç”¨ `rollupOptions.external` æ’é™¤ Firebase
    - æˆ–ä½¿ç”¨ `ssr.noExternal` åŒ…å« Firebase
  - [ ] **é¸é … B**: æ›´æ–° Firebase è‡³ç›¸å®¹ç‰ˆæœ¬
    - ç¢ºèª Firebase æœ€æ–°ç‰ˆæœ¬æ˜¯å¦è§£æ±ºæ­¤å•é¡Œ
    - è©•ä¼°å‡ç´šé¢¨éšªèˆ‡å›æ­¸æ¸¬è©¦éœ€æ±‚
  - [ ] **é¸é … C**: æ·»åŠ  `@rollup/plugin-commonjs` polyfill
    - è©•ä¼°é¡å¤–ä¾è³´çš„å¿…è¦æ€§
    - æª¢æŸ¥ bundle size å½±éŸ¿

#### Task 1.2: é©—è­‰èˆ‡æ±ºç­–

- [ ] é‹è¡Œå°æ¯”æ¸¬è©¦
  - [ ] ç‚ºæ¯å€‹è§£æ±ºæ–¹æ¡ˆå‰µå»ºæ¸¬è©¦åˆ†æ”¯
  - [ ] åœ¨å„åˆ†æ”¯ä¸ŠåŸ·è¡Œ `npm run build`
  - [ ] è¨˜éŒ„æ¯å€‹æ–¹æ¡ˆçš„æˆåŠŸ/å¤±æ•—çµæœ

- [ ] è©•ä¼°æœ€ä½³æ–¹æ¡ˆ
  - [ ] å„ªå…ˆè€ƒæ…®æœ€å°åŒ–æ”¹å‹•çš„æ–¹æ¡ˆ
  - [ ] è€ƒæ…®é•·æœŸç¶­è­·æ€§å’Œç©©å®šæ€§
  - [ ] é¸æ“‡æ¨è–¦æ–¹æ¡ˆä¸¦è¨˜éŒ„ç†ç”±

---

### Phase 2: å¯¦æ–½ä¿®å¾©

æ­¤éšæ®µç›®æ¨™ï¼šå¯¦æ–½é¸å®šæ–¹æ¡ˆï¼Œç¢ºä¿æ§‹å»ºæˆåŠŸã€‚

#### Task 2.1: å¯¦æ–½ä¿®å¾©

- [ ] æ‡‰ç”¨é¸å®šæ–¹æ¡ˆçš„ä¿®æ”¹
  - [ ] æ›´æ–°ç›¸é—œé…ç½®æª”æ¡ˆ (vite.config.ts / package.json)
  - [ ] æˆ–æ›´æ–°ä¾è³´ç‰ˆæœ¬

- [ ] é¦–æ¬¡æ§‹å»ºæ¸¬è©¦
  - [ ] åŸ·è¡Œ `npm run build`
  - [ ] é©—è­‰æ˜¯å¦æˆåŠŸï¼ˆç„¡ç´…è‰²éŒ¯èª¤ï¼‰
  - [ ] æª¢æŸ¥ `dist/` è³‡æ–™å¤¾æ˜¯å¦æ­£ç¢ºç”Ÿæˆ
  - [ ] å¦‚æœå¤±æ•—ï¼Œå˜—è©¦æ›¿ä»£æ–¹æ¡ˆ

#### Task 2.2: å®Œæ•´å“è³ªé©—è­‰

- [ ] åŸ·è¡Œå®Œæ•´æ¸¬è©¦å¥—ä»¶
  - [ ] `npm run type-check` (0 errors)
  - [ ] `npm test` (æ‰€æœ‰æ¸¬è©¦ pass)
  - [ ] `npm run lint` (0 errors)
  - [ ] `npm run format` (ç¢ºä¿ç¨‹å¼ç¢¼æ ¼å¼ä¸€è‡´)

- [ ] é©—è­‰æ‡‰ç”¨åŠŸèƒ½
  - [ ] æª¢æŸ¥ `dist/` è³‡æ–™å¤¾å…§å®¹å®Œæ•´æ€§
  - [ ] é©—è­‰æ‰€æœ‰è³‡æºæª”æ¡ˆæ­£ç¢ºæ‰“åŒ…
  - [ ] ç¢ºèª source maps æ­£ç¢ºç”Ÿæˆ

#### Task 2.3: Phase 2 é©—è­‰

- [ ] åŸ·è¡Œå®Œæ•´æ§‹å»ºåŠæ¸¬è©¦
  - [ ] `npm run build` æˆåŠŸ
  - [ ] `npm test` å…¨æ•¸é€šé
  - [ ] ç„¡å›æ­¸å•é¡Œ

- [ ] è¨˜éŒ„ä¿®å¾©ç´°ç¯€
  - [ ] è¨˜éŒ„é¸å®šçš„è§£æ±ºæ–¹æ¡ˆåŠç†ç”±
  - [ ] è¨˜éŒ„æ‰€æœ‰é…ç½®è®Šæ›´
  - [ ] æ›´æ–° `tech-stack.md` (å¦‚æœ‰ç‰ˆæœ¬æ›´æ–°)

---

### Phase 3: æäº¤èˆ‡æ–‡æª”

æ­¤éšæ®µç›®æ¨™ï¼šæäº¤è®Šæ›´ï¼Œæ›´æ–°ç›¸é—œæ–‡æª”ï¼Œå®Œæˆ bug fixã€‚

#### Task 3.1: æäº¤ä»£ç¢¼è®Šæ›´

- [ ] æº–å‚™æäº¤
  - [ ] æª¢æŸ¥ `git status` ç¢ºèªæ‰€æœ‰å¿…è¦æª”æ¡ˆå·²ä¿®æ”¹
  - [ ] æª¢æŸ¥ `git diff` ç¢ºèªæ”¹å‹•å…§å®¹æ­£ç¢º

- [ ] åŸ·è¡Œæäº¤
  - [ ] æ’°å¯«æ¸…æ™°çš„ commit message:
    ```
    fix(build): Resolve Firebase and Vite CommonJS compatibility issue

    Fixes npm run build failure by [describe the fix]

    - [Change 1]
    - [Change 2]
    - [Change 3]
    ```
  - [ ] Stage æ‰€æœ‰è®Šæ›´: `git add .`
  - [ ] åŸ·è¡Œæäº¤: `git commit -m "..."`

- [ ] é™„åŠ  Git Notes
  - [ ] ç²å– commit hash: `git log -1 --format="%H"`
  - [ ] æ’°å¯«è©³ç´°çš„ task summary
  - [ ] é™„åŠ  git notes: `git notes add -m "..."`

#### Task 3.2: æ›´æ–°æŠ€è¡“æ±ºç­–æ–‡æª”

- [ ] æ›´æ–° `tech-stack.md` (å¦‚éœ€è¦)
  - [ ] è¨˜éŒ„ä»»ä½•ç‰ˆæœ¬æ›´æ–°
  - [ ] è¨˜éŒ„é…ç½®è®Šæ›´
  - [ ] æ·»åŠ æ—¥æœŸè¨»è¨˜

- [ ] æ›´æ–° `conductor/tracks.md`
  - [ ] å°‡æ­¤ track ç‹€æ…‹æ”¹ç‚º âœ… completed

- [ ] æ›´æ–° `plan.md`
  - [ ] è¨˜éŒ„å¯¦éš›æ¡å–çš„è§£æ±ºæ–¹æ¡ˆ
  - [ ] è¨˜éŒ„ä»»ä½•åé›¢è¨ˆåŠƒçš„åœ°æ–¹

#### Task 3.3: æœ€çµ‚é©—è­‰

- [ ] æœ€çµ‚æª¢æŸ¥
  - [ ] é©—è­‰æ‰€æœ‰ commit å·²æ¨é€ (if applicable)
  - [ ] ç¢ºèªæ²’æœ‰éºæ¼çš„è®Šæ›´
  - [ ] æª¢æŸ¥ç›¸é—œæ–‡æª”æ˜¯å¦å·²æ›´æ–°

---

## ğŸ¯ è³ªé‡é–˜é–€ (Quality Gates)

åœ¨æ¨™è¨˜ä»»ä½• task å®Œæˆå‰ï¼Œç¢ºä¿ï¼š

- âœ… `npm run build` æˆåŠŸåŸ·è¡Œ
- âœ… `npm run type-check` ç„¡éŒ¯èª¤
- âœ… `npm test` å…¨æ•¸é€šé
- âœ… `npm run lint` ç„¡éŒ¯èª¤
- âœ… `npm run format` æª¢æŸ¥é€šé
- âœ… æ‰€æœ‰è®Šæ›´å·²æäº¤
- âœ… Git notes å·²é™„åŠ 
- âœ… ç›¸é—œæ–‡æª”å·²æ›´æ–°

---

## ğŸ“Š é æœŸå·¥ä½œé‡

| Phase | é æœŸæ™‚é–“ | å‚™è¨» |
|-------|---------|------|
| Phase 1 | 1-2 å°æ™‚ | è¨ºæ–·èˆ‡è©•ä¼° |
| Phase 2 | 1-2 å°æ™‚ | å¯¦æ–½èˆ‡é©—è­‰ |
| Phase 3 | 0.5-1 å°æ™‚ | æäº¤èˆ‡æ–‡æª” |
| **ç¸½è¨ˆ** | **2.5-5 å°æ™‚** | å–æ±ºæ–¼å•é¡Œè¤‡é›œåº¦ |

---

## ğŸ“ å‚™è¨»

- æ­¤ bug é˜»æ­¢ç”Ÿç”¢ç’°å¢ƒæ§‹å»ºï¼Œæ‡‰å„ªå…ˆè™•ç†
- Phase 1 çš„è¨ºæ–·å·¥ä½œè‡³é—œé‡è¦ï¼Œæ±ºå®šæœ€ä½³è§£æ±ºæ–¹æ¡ˆ
- ä¿®å¾©å¾Œå‹™å¿…åŸ·è¡Œå®Œæ•´çš„å›æ­¸æ¸¬è©¦
- å¦‚é‡åˆ°æ–°çš„éŒ¯èª¤ï¼Œæ‡‰è¨˜éŒ„ä¸¦è©•ä¼°æ˜¯å¦è¶…å‡ºæ­¤ track ç¯„åœ

**ç‹€æ…‹**: â³ å¾…å¯¦æ–½

