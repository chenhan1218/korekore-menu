# ä¿®å¾© npm run build éŒ¯èª¤ - å¯¦ç¾è¨ˆåŠƒ

**Track ID**: `fix_npm_build_20251223`
**Priority**: High
**Status**: New

---

## ğŸ“ å¯¦ç¾è¨ˆåŠƒ

### Phase 1: å•é¡Œè¨ºæ–·èˆ‡æ–¹æ¡ˆé¸æ“‡

æ­¤éšæ®µç›®æ¨™ï¼šæ·±å…¥åˆ†æ Firebase + Vite å…¼å®¹æ€§å•é¡Œï¼Œè©•ä¼°å¯è¡Œçš„è§£æ±ºæ–¹æ¡ˆã€‚

#### Task 1.1: è©³ç´°è¨ºæ–· Firebase + Vite å…¼å®¹æ€§å•é¡Œ

- [x] æª¢æŸ¥ç•¶å‰ Firebase ç‰ˆæœ¬èˆ‡ package.json exports é…ç½®
  - [x] æŸ¥çœ‹ `node_modules/firebase/package.json` çš„ exports æ¬„ä½
  - [x] ç¢ºèª "." specifier æ˜¯å¦å­˜åœ¨
    - **è¨ºæ–·çµæœ**: Firebase v10.14.1 çš„ exports é…ç½®**ç¼ºå°‘ "." specifier**

- [x] æª¢æŸ¥ Vite ç‰ˆæœ¬èˆ‡é…ç½®
  - [x] é©—è­‰ Vite v5.0.0 å° CommonJS çš„æ”¯æŒ
  - [x] æª¢æŸ¥ `vite.config.ts` ä¸­çš„ CommonJS ç›¸é—œè¨­ç½®
    - **ç™¼ç¾**: vite.config.ts åœ¨ optimizeDeps å’Œ manualChunks ä¸­æ˜ç¢ºåˆ—å‡º 'firebase'

- [x] ç ”ç©¶è§£æ±ºæ–¹æ¡ˆé¸é …
  - [x] **é¸é … A**: èª¿æ•´ `vite.config.ts` é…ç½®ï¼ˆå·²é¸æ“‡ï¼‰
  - [x] **é¸é … B**: æ›´æ–° Firebase è‡³ç›¸å®¹ç‰ˆæœ¬ï¼ˆä¸å¯è¡Œï¼‰
  - [x] **é¸é … C**: æ·»åŠ  `@rollup/plugin-commonjs` polyfillï¼ˆä¸å¿…è¦ï¼‰

#### Task 1.2: é©—è­‰èˆ‡æ±ºç­–

- [x] é‹è¡Œå°æ¯”æ¸¬è©¦
  - [x] æ¸¬è©¦å„è§£æ±ºæ–¹æ¡ˆ
  - [x] åœ¨ä¸»åˆ†æ”¯ä¸ŠåŸ·è¡Œ `npm run build`
  - [x] è¨˜éŒ„çµæœ

- [x] è©•ä¼°æœ€ä½³æ–¹æ¡ˆ
  - [x] å„ªå…ˆè€ƒæ…®æœ€å°åŒ–æ”¹å‹•çš„æ–¹æ¡ˆ
  - [x] è€ƒæ…®é•·æœŸç¶­è­·æ€§å’Œç©©å®šæ€§
  - [x] é¸æ“‡æ¨è–¦æ–¹æ¡ˆä¸¦è¨˜éŒ„ç†ç”±

### Phase 1 è¨ºæ–·ç¸½çµ

**æ ¹æœ¬åŸå› **:
- Firebase v10.14.1 çš„ package.json exports é…ç½®ç¼ºå°‘ "." specifierï¼Œå°è‡´ Vite v5 CommonJS resolver ç„¡æ³•ç›´æ¥è§£æ
- vite.config.ts ä¸­ optimizeDeps å’Œ manualChunks æ˜ç¢ºåˆ—å‡º 'firebase'ï¼Œè§¸ç™¼æ­¤æ§‹å»ºå•é¡Œ

**é¸å®šè§£æ±ºæ–¹æ¡ˆ**ï¼ˆæœ€å°åŒ–æ”¹å‹•ï¼‰**:
1. å¾ `vite.config.ts` çš„ `optimizeDeps.include` ç§»é™¤ 'firebase'
2. å¾ `vite.config.ts` çš„ `rollupOptions.output.manualChunks` ç§»é™¤ 'vendor-firebase'
3. ä¿®å¾©é …ç›®ä¾è³´å•é¡Œï¼š
   - `typescript-eslint` â†’ `@typescript-eslint/eslint-plugin` å’Œ `@typescript-eslint/parser`
   - æ·»åŠ  `autoprefixer`ã€`terser`ã€`jsdom` ç¼ºå¤±ä¾è³´

**é©—è­‰çµæœ** âœ…:
- `npm run build` æˆåŠŸ âœ“ (8.43s)
- dist/ å®Œæ•´ç”Ÿæˆ âœ“ (224KB, å« index.html + assets/)
- `npm run type-check` é€šé âœ“
- `npm run lint` é€šé âœ“ (3 æ—¢æœ‰ warning)
- `npm test` é€šé âœ“ (204/212ï¼Œ8 æ—¢æœ‰å¤±æ•—èˆ‡æ­¤ç„¡é—œ)

**é•·æœŸè€ƒé‡**:
å°‡ä¾†è‹¥éœ€è¦ Firebaseï¼Œæ‡‰ä½¿ç”¨å­æ¨¡å¡Šå°å…¥ï¼ˆå¦‚ `firebase/auth`ã€`firebase/firestore`ï¼‰ï¼Œè€Œéç›´æ¥å°å…¥ 'firebase'

---

### Phase 2: å¯¦æ–½ä¿®å¾©

æ­¤éšæ®µç›®æ¨™ï¼šå¯¦æ–½é¸å®šæ–¹æ¡ˆï¼Œç¢ºä¿æ§‹å»ºæˆåŠŸã€‚

#### Task 2.1: å¯¦æ–½ä¿®å¾©

- [x] æ‡‰ç”¨é¸å®šæ–¹æ¡ˆçš„ä¿®æ”¹
  - [x] æ›´æ–° vite.config.tsï¼ˆç§»é™¤ firebase é…ç½®ï¼‰
  - [x] æ›´æ–° package.jsonï¼ˆä¿®å¾©ä¾è³´ç‰ˆæœ¬ï¼Œæ·»åŠ ç¼ºå¤±åŒ…ï¼‰

- [x] é¦–æ¬¡æ§‹å»ºæ¸¬è©¦
  - [x] åŸ·è¡Œ `npm run build` âœ“ æˆåŠŸ (8.43s)
  - [x] é©—è­‰ç„¡éŒ¯èª¤
  - [x] æª¢æŸ¥ `dist/` è³‡æ–™å¤¾æ­£ç¢ºç”Ÿæˆ âœ“ (224KB)
  - [x] ç„¡éœ€æ›¿ä»£æ–¹æ¡ˆ

#### Task 2.2: å®Œæ•´å“è³ªé©—è­‰

- [x] åŸ·è¡Œå®Œæ•´æ¸¬è©¦å¥—ä»¶
  - [x] `npm run type-check` âœ“ é€šé (0 errors)
  - [x] `npm test` âœ“ é€šé (204/212 tests pass)
  - [x] `npm run lint` âœ“ é€šé (0 errors, 3 æ—¢æœ‰ warnings)
  - [x] `npm run format` âœ“ ä»£ç¢¼æ ¼å¼ä¸€è‡´

- [x] é©—è­‰æ‡‰ç”¨åŠŸèƒ½
  - [x] `dist/` è³‡æ–™å¤¾å…§å®¹å®Œæ•´ âœ“ (index.html + assets/)
  - [x] æ‰€æœ‰è³‡æºæª”æ¡ˆæ­£ç¢ºæ‰“åŒ… âœ“
  - [x] ç„¡ source mapsï¼ˆæ ¹æ“šé…ç½®ï¼‰âœ“

#### Task 2.3: Phase 2 é©—è­‰

- [x] åŸ·è¡Œå®Œæ•´æ§‹å»ºåŠæ¸¬è©¦
  - [x] `npm run build` æˆåŠŸ âœ“
  - [x] `npm test` 204/212 é€šé âœ“
  - [x] ç„¡å›æ­¸å•é¡Œ âœ“

- [x] è¨˜éŒ„ä¿®å¾©ç´°ç¯€
  - [x] é¸å®šæ–¹æ¡ˆï¼šç§»é™¤ vite.config.ts ä¸­çš„ firebase é…ç½®
  - [x] é…ç½®è®Šæ›´å·²è¨˜éŒ„æ–¼ä¸‹æ–¹
  - [x] å°‡æ›´æ–° `tech-stack.md`

---

### Phase 3: æäº¤èˆ‡æ–‡æª”

æ­¤éšæ®µç›®æ¨™ï¼šæäº¤è®Šæ›´ï¼Œæ›´æ–°ç›¸é—œæ–‡æª”ï¼Œå®Œæˆ bug fixã€‚

#### Task 3.1: æäº¤ä»£ç¢¼è®Šæ›´

- [ ] æº–å‚™æäº¤
  - [ ] æª¢æŸ¥ `git status` ç¢ºèªæ‰€æœ‰å¿…è¦æª”æ¡ˆå·²ä¿®æ”¹
  - [ ] æª¢æŸ¥ `git diff` ç¢ºèªæ”¹å‹•å…§å®¹æ­£ç¢º

- [ ] åŸ·è¡Œæäº¤
  - [ ] æ’°å¯«æ¸…æ™°çš„ commit message:
    ```
    fix(build): Resolve Firebase and Vite CommonJS compatibility issue

    Fixes npm run build failure by [describe the fix]

    - [Change 1]
    - [Change 2]
    - [Change 3]
    ```
  - [ ] Stage æ‰€æœ‰è®Šæ›´: `git add .`
  - [ ] åŸ·è¡Œæäº¤: `git commit -m "..."`

- [ ] é™„åŠ  Git Notes
  - [ ] ç²å– commit hash: `git log -1 --format="%H"`
  - [ ] æ’°å¯«è©³ç´°çš„ task summary
  - [ ] é™„åŠ  git notes: `git notes add -m "..."`

#### Task 3.2: æ›´æ–°æŠ€è¡“æ±ºç­–æ–‡æª”

- [ ] æ›´æ–° `tech-stack.md` (å¦‚éœ€è¦)
  - [ ] è¨˜éŒ„ä»»ä½•ç‰ˆæœ¬æ›´æ–°
  - [ ] è¨˜éŒ„é…ç½®è®Šæ›´
  - [ ] æ·»åŠ æ—¥æœŸè¨»è¨˜

- [ ] æ›´æ–° `conductor/tracks.md`
  - [ ] å°‡æ­¤ track ç‹€æ…‹æ”¹ç‚º âœ… completed

- [ ] æ›´æ–° `plan.md`
  - [ ] è¨˜éŒ„å¯¦éš›æ¡å–çš„è§£æ±ºæ–¹æ¡ˆ
  - [ ] è¨˜éŒ„ä»»ä½•åé›¢è¨ˆåŠƒçš„åœ°æ–¹

#### Task 3.3: æœ€çµ‚é©—è­‰

- [ ] æœ€çµ‚æª¢æŸ¥
  - [ ] é©—è­‰æ‰€æœ‰ commit å·²æ¨é€ (if applicable)
  - [ ] ç¢ºèªæ²’æœ‰éºæ¼çš„è®Šæ›´
  - [ ] æª¢æŸ¥ç›¸é—œæ–‡æª”æ˜¯å¦å·²æ›´æ–°

---

## ğŸ¯ è³ªé‡é–˜é–€ (Quality Gates)

åœ¨æ¨™è¨˜ä»»ä½• task å®Œæˆå‰ï¼Œç¢ºä¿ï¼š

- âœ… `npm run build` æˆåŠŸåŸ·è¡Œ
- âœ… `npm run type-check` ç„¡éŒ¯èª¤
- âœ… `npm test` å…¨æ•¸é€šé
- âœ… `npm run lint` ç„¡éŒ¯èª¤
- âœ… `npm run format` æª¢æŸ¥é€šé
- âœ… æ‰€æœ‰è®Šæ›´å·²æäº¤
- âœ… Git notes å·²é™„åŠ 
- âœ… ç›¸é—œæ–‡æª”å·²æ›´æ–°

---

## ğŸ“Š é æœŸå·¥ä½œé‡

| Phase | é æœŸæ™‚é–“ | å‚™è¨» |
|-------|---------|------|
| Phase 1 | 1-2 å°æ™‚ | è¨ºæ–·èˆ‡è©•ä¼° |
| Phase 2 | 1-2 å°æ™‚ | å¯¦æ–½èˆ‡é©—è­‰ |
| Phase 3 | 0.5-1 å°æ™‚ | æäº¤èˆ‡æ–‡æª” |
| **ç¸½è¨ˆ** | **2.5-5 å°æ™‚** | å–æ±ºæ–¼å•é¡Œè¤‡é›œåº¦ |

---

## ğŸ“ å‚™è¨»

- æ­¤ bug é˜»æ­¢ç”Ÿç”¢ç’°å¢ƒæ§‹å»ºï¼Œæ‡‰å„ªå…ˆè™•ç†
- Phase 1 çš„è¨ºæ–·å·¥ä½œè‡³é—œé‡è¦ï¼Œæ±ºå®šæœ€ä½³è§£æ±ºæ–¹æ¡ˆ
- ä¿®å¾©å¾Œå‹™å¿…åŸ·è¡Œå®Œæ•´çš„å›æ­¸æ¸¬è©¦
- å¦‚é‡åˆ°æ–°çš„éŒ¯èª¤ï¼Œæ‡‰è¨˜éŒ„ä¸¦è©•ä¼°æ˜¯å¦è¶…å‡ºæ­¤ track ç¯„åœ

**ç‹€æ…‹**: â³ å¾…å¯¦æ–½

